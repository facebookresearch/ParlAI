<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ParlAI: Controllable Dialogue</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">ParlAI
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Controllable Dialogue </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2>Paper information</h2>
<p>Abigail See, Stephen Roller, Douwe Kiela, Jason Weston. <em><a href="https://arxiv.org/abs/1902.08654">What makes a good conversation? How controllable attributes affect human judgments</a></em>. To appear in NAACL 2019.</p>
<h2>Abstract</h2>
<p>A good conversation requires balance &ndash; between simplicity and detail; staying on topic and changing it; asking questions and answering them. Although dialogue agents are commonly evaluated via human judgments of overall quality, the relationship between quality and these individual factors is less well-studied. In this work, we examine two controllable neural text generation methods, conditional training and weighted decoding, in order to control four important attributes for chitchat dialogue: repetition, specificity, response-relatedness and question-asking. We conduct a large-scale human evaluation to measure the effect of these control parameters on multi-turn interactive conversations on the PersonaChat task. We provide a detailed analysis of their relationship to high-level aspects of conversation, and show that by controlling combinations of these variables our models obtain clear improvements in human quality judgments.</p>
<h2>Citation</h2>
<p>If you use the dataset or models in your own work, please cite with the following BibTex entry: </p><pre class="fragment">@inproceedings{see2019what,
  author={Abigail See and Stephen Roller and Douwe Kiela and Jason Weston},
  booktitle={North American Chapter of the Association for Computational Linguistics (NAACL)},
  title={What makes a good conversation? How controllable attributes affect human judgments},
  url={https://arxiv.org/abs/1902.08654},
  year={2019},
}
</pre><h1>Code Instructions</h1>
<p>Once you have <a href="https://github.com/facebookresearch/ParlAI/#installing-parlai">installed ParlAI</a>, follow the instructions below.</p>
<h2>Download the data</h2>
<p>Running the commands to train or chat with the models will automatically download the data for you. Alternatively, you can manually download the data by running <code>python <a class="el" href="projects_2controllable__dialogue_2tasks_2build_8py.html">projects/controllable_dialogue/tasks/build.py</a></code>. This will download the following files to <code>data/controllable_dialogue</code>:</p>
<ul>
<li><code>train.txt</code>: This is Convai2 training data, with extra annotations for three CT controllable attributes (<code>question</code>, <code>lastuttsim</code>, <code>avg_nidf</code>). It is in parlai format.</li>
<li><code>valid.txt</code>: Similarly to train.txt.</li>
<li><code>arora.pkl</code>: This is a pickle file containing information necessary to compute Arora-style sentence embeddings, needed for the response-relatedness control methods.</li>
<li><code>word2count.pkl</code>: This is a pickle file containing information necessary to compute NIDF measures, needed for the specificity control methods.</li>
<li><code>personas_validation.txt</code>: This file contains all the ConvAI2 validation set personas, provided for convenience (useful for talking to the model interactively).</li>
<li><code>ConvAI2_parlaiformat/</code>:<ul>
<li><code>train.txt</code>: This is the ConvAI2 training set (<code>data/ConvAI2/train_self_original_no_cands.txt</code>) converted to parlai format.</li>
<li><code>valid.txt</code>: This is the ConvAI2 validation set (<code>data/ConvAI2/valid_self_original_no_cands.txt</code>) converted to parlai format.</li>
</ul>
</li>
<li><code>wordstat_files/</code>: This directory contains json files with generated output and automatic metrics computed for the various pretrained models.</li>
<li><code>evaluation_logs/</code>: This directory contains logs and evaluations from the human evaluations.</li>
</ul>
<h3>(Alternatively) Making the data yourself</h3>
<p>For reproducibility, in this section we provide the commands to create the data yourself.</p>
<p><em>Note: Due to changes in ParlAI, there might be some small differences between the generated files obtained in this section, and the downloaded files in the previous section.</em></p>
<p>First, convert the ConvAI2 data to ParlAI format: </p><pre class="fragment">mkdir -p data/controllable_dialogue/ConvAI2_parlaiformat

python parlai/scripts/convert_data_to_parlai_format.py \
--task convai2:SelfOriginal:no_cands \
--datatype train:ordered \
--outfile data/controllable_dialogue/ConvAI2_parlaiformat/train.txt

python parlai/scripts/convert_data_to_parlai_format.py \
--task convai2:SelfOriginal:no_cands \
--datatype valid \
--outfile data/controllable_dialogue/ConvAI2_parlaiformat/valid.txt
</pre><p>Next, create <code>word2count.pkl</code>: </p><pre class="fragment">python projects/controllable_dialogue/controllable_seq2seq/nidf.py
</pre><p>This will create a file called <code>word2count.pkl</code> in your <code>data/controllable_dialogue</code> directory. It might take a while, especially the part when it goes through the Twitter dataset counting words.</p>
<p>Next, create <code>arora.pkl</code>: </p><pre class="fragment">python projects/controllable_dialogue/controllable_seq2seq/arora.py
</pre><p>This will create a file called <code>arora.pkl</code> in your <code>data/controllable_dialogue</code> directory. It might take a while - in particular, if necessary it will download GloVe vectors and store them in <code>ParlAI/data/models/glove_vectors</code>.</p>
<p>Next, create <code>data/controllable_dialogue/train.txt</code> and <code>valid.txt</code>: </p><pre class="fragment">python projects/controllable_dialogue/make_control_dataset.py \
--fromfile_datapath data/controllable_dialogue/ConvAI2_parlaiformat/train.txt \
--outfile data/controllable_dialogue/train.txt \
--controls question,lastuttsim,avg_nidf

python projects/controllable_dialogue/make_control_dataset.py \
--fromfile_datapath data/controllable_dialogue/ConvAI2_parlaiformat/valid.txt \
--outfile data/controllable_dialogue/valid.txt \
--controls question,lastuttsim,avg_nidf
</pre><p>This will create files called <code>train.txt</code> and <code>valid.txt</code> in your <code>data/controllable_dialogue</code> directory.</p>
<h2>The pretrained models</h2>
<p>Running the commands in the next section to chat with the pretrained models will automatically download them for you. In <code>data/models/controllable_dialogue</code> you will find the following models, along with their <code>.opt</code> files:</p>
<ul>
<li><code>twitter_pretrained_baseline</code>: A seq2seq model trained on the Twitter dataset.</li>
<li><code>convai2_finetuned_baseline</code>: The <code>twitter_pretrained_baseline</code> model, after fine-tuning on the ConvAI2 dataset.</li>
<li><code>control_avgnidf10b10e</code>: The <code>convai2_finetuned_baseline</code> model, after adding parameters for CT specificity control (10 buckets, embedding size 10), and fine-tuned on the ConvAI2 dataset with loss_CT as described in Section 5.1 of the paper.</li>
<li><code>control_questionb11e10</code>: Similarly to <code>control_avgnidf10b10e</code>, except this is CT question-asking control (11 buckets, embedding size 10).</li>
</ul>
<p>The directory also contains a dictionary file:</p>
<ul>
<li><code>dict_twit30k_train_split</code>: This is the dictionary used for all models.</li>
</ul>
<h2>Chat with the pretrained models</h2>
<p>This section provides the commands to talk to the model configurations described in the paper. You can refer to Table 5 in the paper to see how these commands correspond to the configurations described there.</p>
<p>Running any of these commands will also download the pretrained models, if necessary.</p>
<p><b>Talk to the greedy search baseline model:</b> </p><pre class="fragment">python projects/controllable_dialogue/interactive.py \
-mf models:controllable_dialogue/convai2_finetuned_baseline \
--beam-size 1
</pre><p><b>Talk to the beam search baseline model:</b> </p><pre class="fragment">python projects/controllable_dialogue/interactive.py \
-mf models:controllable_dialogue/convai2_finetuned_baseline
</pre><p>This setting uses beam size 20 by default.</p>
<p><b>Talk to the repetition-controlled (WD) baseline:</b> </p><pre class="fragment">python projects/controllable_dialogue/interactive.py \
-mf models:controllable_dialogue/convai2_finetuned_baseline \
-wd extrep_2gram:-3.5,extrep_nonstopword:-1e20,intrep_nonstopword:-1e20
</pre><p>You can change the weights for these three WD repetition features to be any real number (positive or negative). Here <code>-1e20</code> represents -infinity. In addition, there are other repetition WD features you can use if you wish: see the keys of <code>WDFEATURE2UPDATEFN</code> in <code><a class="el" href="controls_8py.html">controllable_seq2seq/controls.py</a></code>.</p>
<p><b>Talk to the question-controlled CT model (with WD repetition control):</b> </p><pre class="fragment">python projects/controllable_dialogue/interactive.py \
-mf models:controllable_dialogue/control_questionb11e10 \
-wd extrep_2gram:-3.5,extrep_nonstopword:-1e20,intrep_nonstopword:-1e20 \
--set-controls question:7
</pre><p>Here <code>question:7</code> means the '70% questions' bucket. You can set this anywhere between 0 and 10.</p>
<p>To talk to the "z=10 (boost)" version mentioned in the paper: </p><pre class="fragment">python projects/controllable_dialogue/interactive.py \
-mf models:controllable_dialogue/control_questionb11e10 \
-wd extrep_nonstopword:-1e20,intrep_nonstopword:-1e20 \
--set-controls question:10 --beam-reorder best_extrep2gram_qn
</pre><p><b>Talk to the specificity-controlled CT model (with WD repetition control):</b> </p><pre class="fragment">python projects/controllable_dialogue/interactive.py \
-mf models:controllable_dialogue/control_avgnidf10b10e \
-wd extrep_2gram:-3.5,extrep_nonstopword:-1e20,intrep_nonstopword:-1e20 \
--set-controls avg_nidf:7
</pre><p>Here <code>avg_nidf:7</code> means the 7th specificity bucket (where higher is more specific). You can set this anywhere between 0 and 9.</p>
<p><b>Talk to the specificity-controlled WD model (with WD repetition control):</b> </p><pre class="fragment">python projects/controllable_dialogue/interactive.py \
-mf models:controllable_dialogue/convai2_finetuned_baseline \
-wd extrep_2gram:-3.5,extrep_nonstopword:-1e20,intrep_nonstopword:-1e20,nidf:4
</pre><p>Here <code>nidf:4</code> means using the NIDF WD feature with weight 4. You can use any real number as a weight (positive or negative).</p>
<p><b>Talk to the response-relatedness WD model (with WD repetition control):</b> </p><pre class="fragment">python projects/controllable_dialogue/interactive.py \
-mf models:controllable_dialogue/convai2_finetuned_baseline \
-wd extrep_2gram:-3.5,extrep_nonstopword:-1e20,intrep_2gram:-1e20,intrep_nonstopword:-1e20,partnerrep_2gram:-1e20,lastuttsim:5
</pre><p>Here <code>lastuttsim:5</code> means using the response-relatedness WD feature with weight 5. You can use any real number as a weight (positive or negative).</p>
<p>Note that this this feature can take a while to load, especially the first time you run it. This is because we have to load the GloVe vectors from file.</p>
<p><b>Giving the bot a persona</b>: If you want the bot to have a persona when you talk to it, select one of the lines in <code>data/controllable_dialogue/personas_validation.txt</code> and prepend it to your first utterance. Alternatively you can write the persona yourself - but make sure to use the same format.</p>
<p><b>Viewing top 10 beam search candidates:</b> If you want to see the top 10 candidates produced by beam search (rather than just the top 1), add the flag <code>--verbose True</code>.</p>
<h2>Train a CT model</h2>
<p><b>To train a CT model from scratch:</b> </p><pre class="fragment">python projects/controllable_dialogue/train_controllable_seq2seq.py \
-mf /path/to/your/modelfile \
--control-vars avg_nidf
</pre><p>Here we are training a specificity-controlled CT model.</p>
<p><b>To change control embedding size:</b> The CT control embedding size will default to 10, but you could include e.g. <code>--control-embeddingsize 15</code> if you wanted to change it.</p>
<p><b>To change number of buckets:</b> For <code>avg_nidf</code>, the number of buckets will default to 10. If you want to use a different number of buckets, first you need to figure out what the NIDF lower bound should be for each bucket. Suppose you want 8 buckets. First run: </p><pre class="fragment">python projects/controllable_dialogue/get_bucket_lowerbounds.py \
--num_buckets 8 \
--control-vars avg_nidf
</pre><p>and then copy and paste the provided lower bounds into <code><a class="el" href="controls_8py.html">projects/controllable_dialogue/controllable_seq2seq/controls.py</a></code>, similarly to the existing <code>AVG_NIDF_10BUCKET_LBS</code>. Then you can train a model with <code>--control-num-buckets 8</code>.</p>
<p><b>To train a CT model on <em>multiple</em> controls:</b> </p><pre class="fragment">python projects/controllable_dialogue/train_controllable_seq2seq.py \
-mf /path/to/your/modelfile \
--control-vars avg_nidf,question
</pre><p>Here we are training a model conditioned on specificity and question-asking.</p>
<p><b>To take an existing non-CT model and finetune it as a CT model:</b> First, run this command (in this example, taking the ConvAI2-finetuned baseline and adding specificity control): </p><pre class="fragment">python projects/controllable_dialogue/train_controllable_seq2seq.py \
-mf /path/to/your/modelfile \
--init-model models:controllable_dialogue/convai2_finetuned_baseline \
--add-control True \
--control-vars avg_nidf
</pre><p>This command will take the parameters saved in <code>--init-model</code>, load them in the new model (which has randomly initialized weights for the new CT parameters), and then save that model to the given modelfile (<code>-mf</code>). It should be quick. Once that's done, run this command: </p><pre class="fragment">python projects/controllable_dialogue/train_controllable_seq2seq.py \
-mf /path/to/your/modelfile \
--add-control False \
--control-vars avg_nidf
</pre><p>You should see your new CT model training. Note: this is how the models in the paper were trained.</p>
<h2>Look at generated output and automatic metrics</h2>
<p>Once you have downloaded the data, you will find a directory <code>wordstat_files</code> in <code>data/controllable_dialogue</code>. The json files in this directory contain the generated output computed on the ConvAI2 validation set, plus the corresponding automatic metrics. Each json file corresponds to a different model configuration.</p>
<p>Run the following: </p><pre class="fragment">cd projects/controllable_dialogue
jupyter notebook
</pre><p>and then open up <code>inspect_wordstats.ipynb</code>. Where it says <code>models_dir</code>, enter the path to your <code>wordstat_files</code> directory. You will be able to recreate the table of automatic metrics from the paper (Table 6), and explore the models' generated output.</p>
<h2>Save generated output and automatic metrics to file</h2>
<p>If you want to generate json files like those in the previous section, run a command like this: </p><pre class="fragment">python projects/controllable_dialogue/eval_wordstat.py \
-mf models:controllable_dialogue/control_questionb11e10 \
-wd extrep_2gram:-3.5,extrep_nonstopword:-1e20,intrep_nonstopword:-1e20 \
--set-controls question:7
</pre><p>This will create a json file containing the output and automatic metrics for the provided model configuration (here, question-controlled CT model with z=7 and WD repetition control). The script <code>eval_wordstat.py</code> always places the json file in the same place as the model file. The script can take a while to complete - so you can set e.g. <code>--num-examples 512</code> to generate output on a smaller number of examples.</p>
<p><em>Note: Due to changes in ParlAI, there might be some small differences between the json file created via this method, and the json files downloadable in the previous section.</em></p>
<h2>Human Evaluation code, logs, and analysis</h2>
<p>Human evaluation logs should be downloaded automatically after following the download instructions above. You'll find them in the <code>evaluation_logs/</code> folder.</p>
<p>A Jupyter notebook which generates the graphs and tables for the human experiments is available in the <a href="https://github.com/facebookresearch/ParlAI/tree/master/projects/controllable_dialogue">project folder</a>. The notebook should be launched from the ParlAI root directory.</p>
<p>The code for running your own mechanical turk evaluations is also available in the corresponding <a href="https://github.com/facebookresearch/ParlAI/tree/master/projects/controllable_dialogue/mturk">mturk folder</a>. You will probably want to make changes to the <code>model_config.py</code> and <code>run.py</code> to change which models are being evaluated, and then you can launch the experiment with:</p>
<div class="fragment"><div class="line">python parlai/mturk/tasks/controllable_dialogue/run.py -r 0.9 --count-complete --hobby --max-resp-time 1200 --max-connections 20 -nc 1200 --sandbox</div></div><!-- fragment --><p> Change it to <code>--live</code> if you're prepared to spend actual currency. The output must be lightly postprocessed to use it with the analysis tools released. If you intend to do this, please file an issue on the <a href="https://github.com/facebookresearch/ParlAI/">ParlAI GitHub</a>. </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
