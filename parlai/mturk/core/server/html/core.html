<!--
Copyright (c) 2017-present, Facebook, Inc.
All rights reserved.
This source code is licensed under the BSD-style license found in the
LICENSE file in the root directory of this source tree. An additional grant
of patent rights can be found in the PATENTS file in the same directory.
-->
<html>

{% block html_head %}
<head>
<title>MTurk Chat</title>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
</head>
{% endblock %}

<body>
<div class="container-fluid">
<div class="row">

{% block main_pane %}
{% block left_pane %}
<div id="left-pane" class="col-xs-4" style="height: {{frame_height}}px; background-color: #dff0d8; padding: 30px; overflow:scroll;">
    <h1>Live Chat</h1>
    <hr style="border-top: 1px solid #555" />
    <span id="task-description" style="font-size: 16px">
    </span>
</div>
{% endblock %}

{% block right_pane %}
<div id="right-pane" style="min-height: 100%; display: flex; flex-direction: column; justify-content: space-between;">
    <div id="right-top-pane" style="width: 100%; height: 570px; padding-top: 60px; padding-left: 20px; padding-right: 20px; padding-bottom: 20px; overflow:scroll; ">
        <div id="message_thread" style="width: 100%">
        </div>
        <div id="waiting-for-message" class="row" style="margin-left: 0; margin-right: 0; display: none">
            <div class="alert alert-warning" role="alert" style="float: left; display:table; background-color: #fff">
                <div id="hourglass" style="margin-top: -1px; margin-right: 5px; display: inline; float: left;">
                    <?xml version="1.0" encoding="utf-8"?><svg width='25px' height='25px' xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid" class="uil-hourglass"><rect x="0" y="0" width="100" height="100" fill="none" class="bk"></rect><g><path fill="none" stroke="#007282" stroke-width="5" stroke-miterlimit="10" d="M58.4,51.7c-0.9-0.9-1.4-2-1.4-2.3s0.5-0.4,1.4-1.4 C70.8,43.8,79.8,30.5,80,15.5H70H30H20c0.2,15,9.2,28.1,21.6,32.3c0.9,0.9,1.4,1.2,1.4,1.5s-0.5,1.6-1.4,2.5 C29.2,56.1,20.2,69.5,20,85.5h10h40h10C79.8,69.5,70.8,55.9,58.4,51.7z" class="glass"></path><clipPath id="uil-hourglass-clip1"><rect x="15" y="20" width="70" height="25" class="clip"><animate attributeName="height" from="25" to="0" dur="1.5s" repeatCount="indefinite" values="25;0;0" keyTimes="0;0.5;1"></animate><animate attributeName="y" from="20" to="45" dur="1.5s" repeatCount="indefinite" values="20;45;45" keyTimes="0;0.5;1"></animate></rect></clipPath><clipPath id="uil-hourglass-clip2"><rect x="15" y="55" width="70" height="25" class="clip"><animate attributeName="height" from="0" to="25" dur="1.5s" repeatCount="indefinite" values="0;25;25" keyTimes="0;0.5;1"></animate><animate attributeName="y" from="80" to="55" dur="1.5s" repeatCount="indefinite" values="80;55;55" keyTimes="0;0.5;1"></animate></rect></clipPath><path d="M29,23c3.1,11.4,11.3,19.5,21,19.5S67.9,34.4,71,23H29z" clip-path="url(#uil-hourglass-clip1)" fill="#ffab00" class="sand"></path><path d="M71.6,78c-3-11.6-11.5-20-21.5-20s-18.5,8.4-21.5,20H71.6z" clip-path="url(#uil-hourglass-clip2)" fill="#ffab00" class="sand"></path><animateTransform attributeName="transform" type="rotate" from="0 50 50" to="180 50 50" repeatCount="indefinite" dur="1.5s" values="0 50 50;0 50 50;180 50 50" keyTimes="0;0.7;1"></animateTransform></g></svg>
                </div>
                <span style="font-size: 16px">Waiting for the next person to speak...</span>
            </div>
        </div>
    </div>

    <div id="right-bottom-pane" style="width: 100%; background-color: #eee">
        <div id="response-type-idle" class="response-type-module" style="display:none">
        </div>
        <div id="response-type-text-input" class="response-type-module" style="padding-left: 35px; padding-top: 30px; padding-bottom: 30px; padding-right: 35px; float: left; display:none">
            <div style="height: 50px; width: 100%; display: block; float: left; ">
                <input id="id_text_input" type="text" style="width: 80%; height: 100%; float: left; font-size: 16px" class="form-control" value="" placeholder="Please enter here...">
                <button class="btn btn-primary" style="width: 100px; height: 100%; font-size: 16px; float: left; margin-left: 10px; padding: 0px;" id="id_send_msg_button">Send</button>
            </div>
        </div>
        <div id="response-type-done" class="response-type-module" style="padding-left: 35px; padding-top: 30px; padding-bottom: 30px; padding-right: 35px; float: left">
            <button id="done-button" type="button" class="btn btn-primary btn-lg">
                <span class="glyphicon glyphicon-ok-circle" aria-hidden="true"></span> Done with this HIT
            </button>
        </div>
        <div id="response-type-expired" class="response-type-module" style="padding-left: 35px; padding-top: 30px; padding-bottom: 30px; padding-right: 35px; float: left">
            <span style="font-size: 16px">This HIT had already expired.</span>
        </div>
    </div>
</div>
{% endblock %}
{% endblock %}

</div>
</div>
<form id="mturk_submit_form" action="" method="post" style="display:none">
    <input id="assignmentId" name="assignmentId" value="" />
    <input id="hitId" name="hitId" value="" />
    <input id="workerId" name="workerId" value="" />
    <input type="submit" value="Submit" name="submitButton" id="mturk_submit_button" />
</form>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script src="https://cdn.rawgit.com/yf225/jquery-ajax-retry/master/dist/jquery.ajax-retry.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.3/socket.io.js"></script>

<script type="text/javascript">
    /* ================= Utility functions ================= */
    function scroll_conversation_to_bottom() {
        $('div#right-top-pane').animate({
            scrollTop: $('div#right-top-pane').get(0).scrollHeight
        }, 500);
    }

    // Check if in mturk hit page, by checking whether in iframe
    function in_mturk_hit_page () {
        try {
            return window.self !== window.top;
        } catch (e) {
            return true;
        }
    }

    function wait_for_worker_input() {
        update_UI_for_response_type('text_input');
        $("div#waiting-for-message").css("display", "none");
        $("input#id_text_input").focus();
    }

    // Get URL parameter
    function get_url_parameter(sParam) {
        var sPageURL = decodeURIComponent(window.location.search.substring(1)),
            sURLVariables = sPageURL.split('&'),
            sParameterName,
            i;

        for (i = 0; i < sURLVariables.length; i++) {
            sParameterName = sURLVariables[i].split('=');

            if (sParameterName[0] === sParam) {
                return sParameterName[1] === undefined ? true : sParameterName[1];
            }
        }
    };

    function get_hit_config(callback_function) {
        $.ajax({
            url: '/get_hit_config',
            timeout: 3000 // in milliseconds
        }).retry({times: 1000, timeout: 3000}).then(
            function(data) {
                if (verbose_log) console.log(data);
                if (callback_function) {
                    callback_function(data);
                }
            }
        );
    }

    function get_timestamp(callback_function) {
        $.ajax({
            url: '/get_timestamp',
            timeout: 3000 // in milliseconds
        }).retry({times: 1000, timeout: 3000}).then(
            function(data) {
                if (verbose_log) console.log(data);
                if (callback_function) {
                    callback_function(data);
                }
            }
        );
    }

    /* ================= UI related ================= */
    $(window).resize(function() {
        $("input#id_text_input").width($("div#right-bottom-pane").width() - 210);
        $("div#right-top-pane").height($("div#left-pane").height() - $("div#right-bottom-pane").outerHeight() - 20);
    });

    // Handling keypress event
    $(document).keypress(function(e) {
        if (e.which == 13) {
            if (!($("button#id_send_msg_button").prop("disabled") === true)) {
                $("button#id_send_msg_button").click();
            }
        }
    });
    
    /* ================= State variables ================= */
    var verbose_log = true;
    var is_cover_page = (`{{is_cover_page}}` === 'true') ? true : false;
    var task_group_id = `{{task_group_id}}`;
    var hit_index = `{{hit_index}}`;
    var assignment_index = `{{assignment_index}}`;
    var assignmentId = null;
    var hitId = null;
    var workerId = null;
    var conversation_id = `{{conversation_id}}`;
    var cur_agent_id = `{{cur_agent_id}}`;
    var task_description = null;
    var is_sandbox = null;
    var mturk_submit_url = null;
    var num_hits = null;
    var num_assignments = null;
    var hit_is_submitted = false;
    var hit_is_expired = false
    var commands_received = {};
    var messages_received = {};
    var message_list = [];
    var socket = null;
    var task_done = false;
    var state_lock = false; // We need to acquire this lock first before attempting to update the UI state with new messages or commands.

    /* ================= Message handling ================= */

    function sort_by_key(array, key) {
        return array.sort(function(a, b) {
            var x = a[key]; var y = b[key];
            return ((x < y) ? -1 : ((x > y) ? 1 : 0));
        });
    }

    function filter_duplicated_messages(unfiltered_message_list) {
        var new_message_list = [];
        var current_message_id = null;
        unfiltered_message_list = sort_by_key(unfiltered_message_list, 'message_id');

        for (var i = 0; i < unfiltered_message_list.length; i++) {
            var message = unfiltered_message_list[i];
            if (!(message['message_id'] === current_message_id)) {
                new_message_list.push(message);
                current_message_id = message['message_id'];
            }
        }
        return new_message_list;
    }

    function handle_new_messages(new_messages) {
        var new_message_list = message_list.concat(new_messages);
        new_message_list = filter_duplicated_messages(new_message_list);
        if (new_message_list.length <= message_list.length) {
            return false;
        }
        message_list = new_message_list;
        message_list = sort_by_key(message_list, 'timestamp');

        $('div#message_thread').empty();

        for (var i = 0; i < message_list.length; i++) {
            var message = message_list[i];
            var agent_id = message['id'];
            var message_id = message['message_id'];
            var message_text = message['text'].replace(/(?:\r\n|\r|\n)/g, '<br />');

            if (agent_id != cur_agent_id) {
                $('div#message_thread').append(`
                    <div class="row" style="margin-left: 0; margin-right: 0">
                        <div class="alert alert-warning" role="alert" style="float: left; display:table">
                            <span style="font-size: 16px"><b>`+agent_id+`</b>: `+message_text+`</span>
                        </div>
                    </div>
                `);
                received_message_from_other_agents = true;
            } else {
                $('div#message_thread').append(`
                    <div class="row" style="margin-left: 0; margin-right: 0">
                        <div class="alert alert-info" role="alert" style="float: right; display:table">
                            <span style="font-size: 16px"><b>`+agent_id+`</b>: `+message_text+`</span>
                        </div>
                    </div>
                `);
            }
        }
        if (message_list.length > 0) {
            $("div#message_thread").css("display", "");
            scroll_conversation_to_bottom();
        }
        return true;
    }

    function uuidv4() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    function send_message(text, receiver_agent_id, episode_done, callback_function=null) {
        if (socket) {
            get_timestamp(function(data) {
                var timestamp = data['timestamp'];
                var message = {
                    task_group_id: task_group_id,
                    conversation_id: conversation_id,
                    sender_agent_id: cur_agent_id,
                    receiver_agent_id: receiver_agent_id,
                    message_id: uuidv4(),
                    timestamp: timestamp,

                    id: cur_agent_id,
                    episode_done: episode_done
                }
                if (text) message['text'] = text;

                _send_event_to_socket(
                    'agent_send_message', 
                    message,
                    function (data) {
                        if (verbose_log) console.log(data);

                        if (callback_function) {
                            callback_function(data);
                        }
                    }
                );
            });
        }
    }

    $("button#id_send_msg_button").on('click', async function () {
        var text = $("input#id_text_input").val();
        if (!(text == '')) {
            $("button#id_send_msg_button").addClass("disabled");
            $("button#id_send_msg_button").prop("disabled", true);

            while (state_lock) await sleep(500);
            state_lock = true;
            send_message(text, '[World]', false, function(data){
                $("button#id_send_msg_button").removeClass("disabled");
                $("button#id_send_msg_button").prop("disabled", false);
                $("input#id_text_input").val("");
                $("div#response-type-text-input").css("display", "none");
                var new_messages = [];
                new_messages.push(data);
                if (handle_new_messages(new_messages) && !task_done) {
                    $("div#waiting-for-message").css("display", "");
                }
                after_send_message();
                state_lock = false;
            });
        }
    });

    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    function _send_event_to_socket(event_name, event_data, callback_function=null) {
        var event_sent = false;
        var timeout = 2; // in seconds
        var start_time = Date.now();
        async function check_event_sent() {
            while (event_sent === false) {
                if ((Date.now() - start_time) > (timeout * 1000)) { // Timeout
                    console.log(event_name + ' not acknowledged by server. Sending event again.');
                    _send_event_to_socket(event_name, event_data, callback_function);
                    return
                } else {
                    await sleep(500);
                }
            }
        }
        socket.emit(event_name, event_data, function(data) {
            event_sent = true;
            if (callback_function) {
                callback_function(data);
            }
        });
        check_event_sent();
    }

    function setup_socket() {
        var host = window.location.hostname;
        socket = io(host);
        socket.on('socket_open', function() {
            if (verbose_log) console.log('Server connected.');
            _send_event_to_socket(
                'agent_alive', 
                {
                    task_group_id: task_group_id,
                    conversation_id: conversation_id,
                    agent_id: cur_agent_id,
                    assignment_id: assignmentId,
                    hit_id: hitId,
                    worker_id: workerId
                },
                function(data) {
                    if (verbose_log) console.log(data);
                }
            );
        });
        socket.on('disconnect', function() {
            if (verbose_log) console.log('Server disconnected.');
        });
        socket.on('new_command', async function (data) {
            if (verbose_log) console.log(data);
            command = data['command'];

            _send_event_to_socket(
                'new_command_received',
                {
                    task_group_id: task_group_id,
                    conversation_id: conversation_id,
                    agent_id: cur_agent_id
                }
            );

            if (commands_received[data['command_id']]) {
                return;
            }
            commands_received[data['command_id']] = true;

            while (state_lock) await sleep(500);
            state_lock = true;
            if (command === 'COMMAND_SEND_MESSAGE') {
                wait_for_worker_input();
            } else if (command === 'COMMAND_SHOW_DONE_BUTTON') {
                task_done = true;
                update_UI_for_response_type('done');
                $("div#waiting-for-message").css("display", "none");
            } else if (command === 'COMMAND_EXPIRE_HIT') {
                update_UI_for_response_type('expired');
                hit_is_expired = true;
                $("div#waiting-for-message").css("display", "none");
            } else if (command === 'COMMAND_SUBMIT_HIT') {
                all_done_callback();
            } else if (command === 'COMMAND_DISCONNECT_PARTNER') {
                update_UI_for_response_type('done');
                $('#done-button').before('<b style="margin-right: 10px">Your partner unexpectedly left the conversation!</b>');
            }
            after_receive_command(command);
            state_lock = false;
        });
        socket.on('new_message', async function (data) {
            if (verbose_log) console.log(data);
            message = data;

            _send_event_to_socket(
                'new_message_received',
                {
                    task_group_id: task_group_id,
                    conversation_id: conversation_id,
                    agent_id: cur_agent_id
                }
            );

            if (messages_received[message['message_id']]) {
                return;
            }
            messages_received[message['message_id']] = true;

            while (state_lock) await sleep(500);
            state_lock = true;
            var new_messages = [];
            new_messages.push(message);
            handle_new_messages(new_messages);
            after_receive_message(message);
            state_lock = false;
        });
    }

    function send_heartbeat() {
        console.log('heartbeat');
        _send_event_to_socket(
            'agent_heartbeat',
            {
                task_group_id: task_group_id,
                conversation_id: conversation_id,
                sender_agent_id: cur_agent_id,
                receiver_agent_id: '[World]'
            }
        );

        setTimeout(send_heartbeat, 1000);
    }

    function update_UI_for_response_type(response_type) {
        $("div.response-type-module").css("display", "none");

        if (response_type == 'idle') {
            $("div#response-type-idle").css("display", "");
        } else if (response_type == 'text_input') {
            $("div#response-type-text-input").css("display", "");
        } else if (response_type == 'done') {
            $("div#response-type-done").css("display", "");
        } else if (response_type == 'expired') {
            $("div#response-type-expired").css("display", "");
        }
        $(window).resize();
    }

    $("button#done-button").on('click', function() {
        all_done_callback();
    });

    function all_done_callback() {
        if (in_mturk_hit_page()) {
            hit_is_submitted = true;
            $("input#mturk_submit_button").click();
        }
    }

    if (!is_cover_page) {
        window.onbeforeunload = function() {
            if (hit_is_submitted || hit_is_expired) {
                return undefined;
            } else {
                return true;
            }
        }
    }

    function init_cover_page() {
        $("span#task-description").html(task_description);
    }

    function init_chat_page() {
        // Data related
        $("form#mturk_submit_form input#assignmentId").val(assignmentId);
        $("form#mturk_submit_form input#hitId").val(hitId);
        $("form#mturk_submit_form input#workerId").val(workerId);
        $("form#mturk_submit_form").attr("action", mturk_submit_url);
        $("span#task-description").html(task_description);

        // UI related
        update_UI_for_response_type('idle');
        $("div#waiting-for-message").css("display", "");
        $("div#left-pane").removeClass('col-xs-12');
        $("div#left-pane").addClass('col-xs-4');

        $(window).resize();

        setup_socket();
        send_heartbeat();
    }


    $(document).ready(function() {
        get_hit_config(function(data) {
            task_description = data['task_description'];
            is_sandbox = data['is_sandbox'];
            mturk_submit_url = data['mturk_submit_url'];
            num_hits = data['num_hits'];
            num_assignments = data['num_assignments'];

            assignmentId = get_url_parameter('assignmentId');
            hitId = get_url_parameter('hitId');
            workerId = get_url_parameter('workerId');

            if (is_cover_page) {
                init_cover_page();
            } else {
                init_chat_page();
            }
        });
    });
    function after_receive_command(command) {};
    function after_receive_message(message) {};
    function after_send_message() {};
</script>

{% block additional_scripts %}
{% endblock %}

</body>
</html>